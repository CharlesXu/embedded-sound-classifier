%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% University Assignment Title Page 
% LaTeX Template
% Version 1.0 (27/12/12)
%
% This template has been downloaded from:
% http://www.LaTeXTemplates.com
%
% Original author:
% WikiBooks (http://en.wikibooks.org/wiki/LaTeX/Title_Creation)
%
% License:
% CC BY-NC-SA 3.0 (http://creativecommons.org/licenses/by-nc-sa/3.0/)
% 
% Instructions for using this template:
% This title page is capable of being compiled as is. This is not useful for 
% including it in another document. To do this, you have two options: 
%
% 1) Copy/paste everything between \begin{document} and \end{document} 
% starting at \begin{titlepage} and paste this into another LaTeX file where you 
% want your title page.
% OR
% 2) Remove everything outside the \begin{titlepage} and \end{titlepage} and 
% move this file to the same directory as the LaTeX file you wish to add it to. 
% Then add \input{./title_page_1.tex} to your LaTeX file where you want your
% title page.
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\title{Title page with logo}
%----------------------------------------------------------------------------------------
%	PACKAGES AND OTHER DOCUMENT CONFIGURATIONS
%----------------------------------------------------------------------------------------

\documentclass[12pt]{article}
\usepackage[english]{babel}
\usepackage[utf8x]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorinlistoftodos]{todonotes}

\begin{document}

\begin{titlepage}

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}} % Defines a new command for the horizontal lines, change thickness here


\center % Center everything on the page
 
%----------------------------------------------------------------------------------------
%	HEADING SECTIONS
%----------------------------------------------------------------------------------------

\textsc{\LARGE Politenico di Milano}\\[1.5cm] % Name of your university/college
\textsc{\Large Dipartimento Elettronica, Informazione e Bioingegneria}\\[0.5cm] % Major heading such as course name
\textsc{\large \textbf{Advanced Operating Systems:} Project Report}\\[0.5cm] % Minor heading such as course title

%----------------------------------------------------------------------------------------
%	TITLE SECTION
%----------------------------------------------------------------------------------------

\HRule \\[0.4cm]
{ \huge \bfseries Embedded Neural Network}\\[0.4cm] % Title of your document
\HRule \\[1.5cm]
 
%----------------------------------------------------------------------------------------
%	AUTHOR SECTION
%----------------------------------------------------------------------------------------

\begin{minipage}{0.4\textwidth}
\begin{flushleft} \large
\emph{Author:}\\
Michele \textsc{Scuttari}
Marina \textsc{Nikolic} % Your name
\end{flushleft}
\end{minipage}
~
\begin{minipage}{0.4\textwidth}
\begin{flushright} \large
\emph{Supervisor:} \\
Dr. Federico \textsc{Terraneo} % Supervisor's Name
\end{flushright}
\end{minipage}\\[1.5cm]

% If you don't want a supervisor, uncomment the two lines below and remove the section above
%\Large \emph{Author:}\\
%John \textsc{Smith}\\[3cm] % Your name

%----------------------------------------------------------------------------------------
%	DATE SECTION
%----------------------------------------------------------------------------------------

{\large \today}\\[2cm] % Date, change the \today to a set date if you want to be precise


%----------------------------------------------------------------------------------------
%	LOGO SECTION
%----------------------------------------------------------------------------------------


\begin{center}
	\includegraphics[scale=0.25]{Logo_Politecnico_Milano.png}                                               
\end{center}

% Include a department/university logo - this will require the graphicx package 
%----------------------------------------------------------------------------------------


\vfill % Fill the rest of the page with whitespace

\end{titlepage}




\begin{abstract}
In this document we will discuss about the implementation of a sound classifier on a STM32 board. % continue
\end{abstract}

\section{Introduction}

\subsection{The Problem To Solve}
% ...
\subsection{Why Neural Networks?}
For recognition and analysis of sound, AI techinques are used because of the complexity of the computations and the amount of noise present in the environment. Another important issue is that instances of the same sound have high variability due to different (yet omogeneus) sources. For example, think about word recognition: an effective application should recognise a word even if spoken by different people. 
\subsubsection{Which kind of NN?}
Here we are using a sequential feed-forward neural network. Since we are trying to distinguish two differnt sounds, the NN is a classifier which output has one-hot codification. 
This simple model is expected to work because of the simplicity of the problem and the caracterization of the two sounds. It gets as input the FFT of a time window.
\subsubsection{How to implement NN on a board?}
The STM32cube.ai allows to compile a pre-trained neural network into a library to be called in the code. %... more about STM32Cube.ai

\subsection{Acronyms and Definitions}
\begin{itemize}
 \item \textbf{AI:} Artificial Intelligence
 \item \textbf{NN:} Neural Network
 \item \textbf{FFT:} Fast Fourier Transformation
\end{itemize}


\section{Design and Implementation}
\subsection{Board Programming}
\subsubsection{Board description}
The board in use is a \textbf{STM32F4 Discovery} (STM32F407VGT6) and makes use of the open source operating system Miosix.\\
The peripherals used in this project are the microphone, the user button and the USART, although also the CRC module is enabled because needed by the ST's AI library.

\subsubsection{Microphone}
The board is equipped with a \textbf{MP45DT02} MEMS microphone, which produces a stream of 1-bit Digital Pulse Modulation (PDM) samples. The PDM samples are then converted to 16-bit signed PCM samples by using a low pass filter.\\
In the end, the PCM data is sampled at a frequency of 32 kHz, which is obtained by setting the \textit{PLLI2SN}, \textit{PLLI2SR} and \textit{I2SDIV} registers to appropriate values (see chapters \textit{7.3.23} and \textit{28.4.4} of the datasheet for further details).
\begin{flalign*}
&f_\text{(VCO clock)} = f_\text{(PLLI2S clock input)} * \frac{PLLI2SN}{PLLM} = 8\text{ MHz}\ \frac{213}{8} = 213 \text{ MHz}\\
&f_\text{(PLL I2S clock output)} = \frac{f_\text{(VCO clock)}}{PLLI2SR} = \frac{213\text{ MHz}}{2} = 106,5\text{ MHz}\\
&f_\text{(PDM)} = \frac{f_\text{(PLL I2S clock output)}}{2 * I2SDIV * 8} = \frac{106,5\text{ MHz}}{2 * 13 * 8} = 512\text{ kHz}\\
&f_\text{(PCM)} = \frac{f_\text{(PDM)}}{16} = \frac{512\text{ kHz}}{16} = 32\text{ kHz}
\end{flalign*}
The driver also uses a double buffering strategy: one buffer is used to collect the real time PDM samples coming from the microphone, while the other is used to contain the data to be processed. This way, while DMA refills the first buffer, the other one doesn't change and its data can be processed. When the DMA refills end, an interrupt is raised and the buffers are swapped.

\subsubsection{FFT}
The PCM samples are considered in blocks of 1024 values. On each window, the FFT is computed and, being the output symmetric (because all the input has zero imaginary part), only half of the 1024 output bins are taken. Before the values are processed, they are normalized and passed through a Hann window function.\\
Being the Cortex M4 equipped with the \textbf{Digital Signal Processor} (DSP), the conversion is done using the dedicated hardware.

\subsubsection{User button}
The user button press is handled by enabling the EXTI0 interrupt. The calling thread is paused while waiting for the press event. Moreover, a software debouncing feature is implemented in order to avoid multiple clicks due to the mechanical structure of the button.

\subsubsection{USART}
The communication between the board and the client is done through USART connection (PA2 = TX, PA3 = RX), configured with a speed of 115200 bps.

\subsubsection{Neural network library}
The neural network library is generated by the X-CUBE-AI expansion pack for STM32CubeMX. This tool automatically converts the pretrained Keras model into a C library that can be called by the main program.\\
Instead, the core of the network runtime is provided by ST as a static closed source library (\textit{neural\_network.a}).

\subsubsection{Issues}
\begin{itemize}
    \item The Miosix build system has been converted to CMake, in order to allow the usage of modern IDEs such as CLion. In fact, the suggested IDE Netbeans was giving a lot of troubles in the development, such as missing code completion and unrecognized definitions.
    \item The Miosix toolchain has a bug in the linking phase, resulting in the network runtime library to block in an infinite loop when its functions are called. To solve this issue, the linking process has been executed using the standard ARM linker.
\end{itemize}

\subsection{Network Training}
The board software can be compiled in two different way, by enabling or disabling the \textit{TRAINING} variable definition. When defined, the neural network is not executed and the FFT samples are directly transferred to the client. This way, it is possible to obtain the data to separately train the network. When trained and uploaded, the variable definition can be removed in order to enable the normal operating mode, in which the neural network runs and outputs the recognized sound.

\subsection{Testing}

\section{Experimental Results}

\section{Conclusions}
\subsection{...}
\subsection{Possible Use Cases}
\subsection{Future Improvements}


% delete when finished writing
\section{Some \LaTeX{} Examples}
\label{sec:examples}

\subsection{Sections}

Use section and subsection commands to organize your document. \LaTeX{} handles all the formatting and numbering automatically. Use ref and label commands for cross-references.

\subsection{Comments}

Comments can be added to the margins of the document using the \todo{Here's a comment in the margin!} todo command, as shown in the example on the right. You can also add inline comments too:

\todo[inline, color=green!40]{This is an inline comment.}

\subsection{Tables and Figures}

Use the table and tabular commands for basic tables --- see Table~\ref{tab:widgets}, for example. You can upload a figure (JPEG, PNG or PDF) using the files menu. To include it in your document, use the includegraphics command as in the code for Figure~\ref{fig:frog} below.

% Commands to include a figure:
\begin{figure}
\centering
\includegraphics[width=0.5\textwidth]{frog.jpg}
\caption{\label{fig:frog}This is a figure caption.}
\end{figure}

\begin{table}
\centering
\begin{tabular}{l|r}
Item & Quantity \\\hline
Widgets & 42 \\
Gadgets & 13
\end{tabular}
\caption{\label{tab:widgets}An example table.}
\end{table}

\subsection{Mathematics}

\LaTeX{} is great at typesetting mathematics. Let $X_1, X_2, \ldots, X_n$ be a sequence of independent and identically distributed random variables with $\text{E}[X_i] = \mu$ and $\text{Var}[X_i] = \sigma^2 < \infty$, and let
$$S_n = \frac{X_1 + X_2 + \cdots + X_n}{n}
      = \frac{1}{n}\sum_{i}^{n} X_i$$
denote their mean. Then as $n$ approaches infinity, the random variables $\sqrt{n}(S_n - \mu)$ converge in distribution to a normal $\mathcal{N}(0, \sigma^2)$.

\subsection{Lists}

You can make lists with automatic numbering \dots

\begin{enumerate}
\item Like this,
\item and like this.
\end{enumerate}
\dots or bullet points \dots
\begin{itemize}
\item Like this,
\item and like this.
\end{itemize}

We hope you find write\LaTeX\ useful, and please let us know if you have any feedback using the help menu above.

\end{document}
